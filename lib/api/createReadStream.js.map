{"version":3,"sources":["src/createReadStream.js"],"names":[],"mappings":"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","file":"createReadStream.js","sourcesContent":["import Bigint from '../tools/bigint'\nimport Bluebird from 'bluebird'\nimport {Readable} from 'stream'\nimport {request} from '../tools/smb2-forge'\n\nconst requestAsync = Bluebird.promisify(request)\n\nconst maxPacketSize = 0x00010000\n\nclass SmbReadableStream extends Readable {\n  constructor (connection, file, options = {}) {\n    super(options)\n\n    const {\n      start = 0,\n      end,\n      encoding\n    } = options\n\n    this.connection = connection\n    this.encoding = encoding\n    this.file = file\n    this.offset = new Bigint(8, start)\n\n    let fileLength = 0\n    for (let i = 0; i < file.EndofFile.length; i++) {\n      fileLength += file.EndofFile[i] * Math.pow(2, i * 8)\n    }\n    this.fileLength = fileLength\n    this.wait = false\n\n    if (end >= 0 && end < fileLength) {\n      this.fileLength = end + 1\n    }\n  }\n\n  async _read (size) {\n    while (this.offset.lt(this.fileLength)/* && size > 0*/) {\n      if (this.wait) {\n        return\n      }\n      const rest = this.offset.sub(this.fileLength).neg()\n      const packetSize = Math.min(maxPacketSize, rest.toNumber()/*, size*/)\n\n      const offset = new Bigint(this.offset)\n      this.wait = true\n      let content = await requestAsync('read', {\n        FileId: this.file.FileId,\n        Length: packetSize,\n        Offset: offset.toBuffer()\n      }, this.connection)\n      this.wait = false\n\n      if (this.encoding) {\n        content = content.toString(this.encoding)\n      }\n      this.offset = this.offset.add(packetSize)\n      // size -= packetSize\n      if (!this.push(content)) {\n        return\n      }\n    }\n    if (this.offset.ge(this.fileLength)) {\n      this.push(null)\n      await requestAsync('close', this.file, this.connection)\n    }\n  }\n}\n\nexport default function (path, options, cb) {\n  if (typeof options === 'function') {\n    cb = options\n    options = {}\n  }\n  request('open', {path}, this, (err, file) => {\n    if (err) {\n      if (err.code === 'STATUS_OBJECT_NAME_NOT_FOUND') {\n        err.code = 'ENOENT'\n      }\n      cb(err)\n    } else {\n      cb(null, new SmbReadableStream(this, file, options))\n    }\n  })\n}\n"]}